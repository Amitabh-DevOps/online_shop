name: Destroy Infrastructure

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "destroy" to confirm destruction'
        required: true
        type: string

env:
  AWS_REGION: eu-west-1

jobs:
  # Job 1: Destroy Main Infrastructure
  destroy-infrastructure:
    name: Destroy Infrastructure
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm == 'destroy'
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.6.0"

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Destroy Main Infrastructure
        run: |
          echo "ðŸ”¥ Destroying main infrastructure..."
          cd infrastructure/main
          
          # Create backend config
          cat > backend.hcl << EOF
          bucket         = "${{ secrets.STATE_BUCKET_NAME }}"
          key            = "terraform.tfstate"
          region         = "${{ env.AWS_REGION }}"
          dynamodb_table = "${{ secrets.DYNAMODB_TABLE_NAME }}"
          encrypt        = true
          EOF
          
          # Initialize with backend
          terraform init -backend-config=backend.hcl
          
          # Destroy infrastructure
          terraform destroy -auto-approve \
            -var="aws_region=${{ env.AWS_REGION }}" \
            -var="public_key=${{ secrets.EC2_PUBLIC_KEY }}" \
            -var="docker_image=${{ secrets.DOCKERHUB_USERNAME }}/online-shop:latest"
          
          echo "âœ… Main infrastructure destroyed"

  # Job 2: Destroy Backend Infrastructure
  destroy-backend:
    name: Destroy Backend
    runs-on: ubuntu-latest
    needs: destroy-infrastructure
    if: github.event.inputs.confirm == 'destroy'
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.6.0"

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Empty S3 Bucket
        run: |
          echo "ðŸ—‘ï¸  Emptying S3 bucket..."
          
          # Delete all object versions
          aws s3api list-object-versions \
            --bucket "${{ secrets.STATE_BUCKET_NAME }}" \
            --query 'Versions[].{Key: Key, VersionId: VersionId}' \
            --output json | \
          jq -r '.[] | "--key \"\(.Key)\" --version-id \(.VersionId)"' | \
          while IFS= read -r line; do
            if [ -n "$line" ]; then
              aws s3api delete-object --bucket "${{ secrets.STATE_BUCKET_NAME }}" $line || true
            fi
          done
          
          # Delete all delete markers
          aws s3api list-object-versions \
            --bucket "${{ secrets.STATE_BUCKET_NAME }}" \
            --query 'DeleteMarkers[].{Key: Key, VersionId: VersionId}' \
            --output json | \
          jq -r '.[] | "--key \"\(.Key)\" --version-id \(.VersionId)"' | \
          while IFS= read -r line; do
            if [ -n "$line" ]; then
              aws s3api delete-object --bucket "${{ secrets.STATE_BUCKET_NAME }}" $line || true
            fi
          done
          
          # Remove any remaining objects
          aws s3 rm s3://${{ secrets.STATE_BUCKET_NAME }} --recursive || true
          
          echo "âœ… S3 bucket emptied"
        continue-on-error: true

      - name: Destroy Backend Infrastructure
        run: |
          echo "ðŸ”¥ Destroying backend infrastructure..."
          cd infrastructure/backend
          
          # Initialize Terraform
          terraform init
          
          # Destroy backend
          terraform destroy -auto-approve \
            -var="state_bucket_name=${{ secrets.STATE_BUCKET_NAME }}" \
            -var="dynamodb_table_name=${{ secrets.DYNAMODB_TABLE_NAME }}" \
            -var="aws_region=${{ env.AWS_REGION }}"
          
          echo "âœ… Backend infrastructure destroyed"

  # Job 3: Verify Cleanup
  verify-cleanup:
    name: Verify Cleanup
    runs-on: ubuntu-latest
    needs: [destroy-infrastructure, destroy-backend]
    if: github.event.inputs.confirm == 'destroy'
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Verify All Resources Destroyed
        run: |
          echo "ðŸ” Verifying cleanup..."
          CLEANUP_STATUS="COMPLETE"
          
          # Check S3 bucket
          if aws s3api head-bucket --bucket "${{ secrets.STATE_BUCKET_NAME }}" 2>/dev/null; then
            echo "âš ï¸  S3 bucket still exists"
            CLEANUP_STATUS="PARTIAL"
          else
            echo "âœ… S3 bucket destroyed"
          fi
          
          # Check DynamoDB table
          if aws dynamodb describe-table --table-name "${{ secrets.DYNAMODB_TABLE_NAME }}" 2>/dev/null; then
            echo "âš ï¸  DynamoDB table still exists"
            CLEANUP_STATUS="PARTIAL"
          else
            echo "âœ… DynamoDB table destroyed"
          fi
          
          # Check for remaining EC2 instances
          INSTANCES=$(aws ec2 describe-instances \
            --filters "Name=tag:Project,Values=online-shop" "Name=instance-state-name,Values=running,pending,stopping,stopped" \
            --query 'Reservations[*].Instances[*].InstanceId' \
            --output text)
          
          if [ -n "$INSTANCES" ] && [ "$INSTANCES" != "None" ]; then
            echo "âš ï¸  Found remaining EC2 instances: $INSTANCES"
            CLEANUP_STATUS="PARTIAL"
          else
            echo "âœ… No remaining EC2 instances"
          fi
          
          echo "Cleanup status: $CLEANUP_STATUS"
          
          if [ "$CLEANUP_STATUS" = "COMPLETE" ]; then
            echo "ðŸŽ‰ All resources destroyed successfully!"
          else
            echo "âš ï¸  Some resources may still exist. Please check AWS console."
          fi

  # Job 4: Send Notification
  notify:
    name: Send Notification
    runs-on: ubuntu-latest
    needs: [destroy-infrastructure, destroy-backend, verify-cleanup]
    if: always() && github.event.inputs.confirm == 'destroy'
    steps:
      - name: Determine Status
        id: status
        run: |
          if [[ "${{ needs.destroy-infrastructure.result }}" == "success" ]] && \
             [[ "${{ needs.destroy-backend.result }}" == "success" ]] && \
             [[ "${{ needs.verify-cleanup.result }}" == "success" ]]; then
            echo "result=Success âœ…" >> $GITHUB_OUTPUT
            echo "message=All infrastructure destroyed successfully" >> $GITHUB_OUTPUT
          else
            echo "result=Failed âŒ" >> $GITHUB_OUTPUT
            echo "message=Some resources may not have been destroyed" >> $GITHUB_OUTPUT
          fi

      - name: Send Email Notification
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "ðŸ”¥ Infrastructure Destroyed - ${{ steps.status.outputs.result }}"
          to: ${{ secrets.MAIL_TO }}
          from: ${{ secrets.MAIL_FROM }}
          html_body: |
            <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
              <h2 style="color: #d73a49;">ðŸ”¥ Infrastructure Destruction Complete</h2>
              <p><strong>Status:</strong> ${{ steps.status.outputs.result }}</p>
              <p><strong>Message:</strong> ${{ steps.status.outputs.message }}</p>
              <p><strong>Repository:</strong> ${{ github.repository }}</p>
              <p><strong>Triggered by:</strong> ${{ github.actor }}</p>
              <p><strong>Timestamp:</strong> ${{ github.event.head_commit.timestamp }}</p>
              <hr>
              <h3>Job Results:</h3>
              <ul>
                <li>Destroy Infrastructure: ${{ needs.destroy-infrastructure.result }}</li>
                <li>Destroy Backend: ${{ needs.destroy-backend.result }}</li>
                <li>Verify Cleanup: ${{ needs.verify-cleanup.result }}</li>
              </ul>
              <p><a href="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}">View Details</a></p>
            </div>
        continue-on-error: true
