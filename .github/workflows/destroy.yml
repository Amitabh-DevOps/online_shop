name: Destroy Infrastructure

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "destroy" to confirm destruction'
        required: true
        type: string

env:
  AWS_REGION: eu-west-1

jobs:
  # Job 1: Destroy Main Infrastructure
  destroy-infrastructure:
    name: Destroy Infrastructure
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm == 'destroy'
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.6.0"

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Destroy Main Infrastructure
        run: |
          echo "ğŸ”¥ Destroying main infrastructure..."
          cd infrastructure/main
          
          # Create backend config
          cat > backend.hcl << EOF
          bucket         = "${{ secrets.STATE_BUCKET_NAME }}"
          key            = "terraform.tfstate"
          region         = "${{ env.AWS_REGION }}"
          dynamodb_table = "${{ secrets.DYNAMODB_TABLE_NAME }}"
          encrypt        = true
          EOF
          
          # Initialize with backend
          terraform init -backend-config=backend.hcl
          
          # Destroy infrastructure
          terraform destroy -auto-approve \
            -var="aws_region=${{ env.AWS_REGION }}" \
            -var="public_key=${{ secrets.EC2_PUBLIC_KEY }}" \
            -var="docker_image=${{ secrets.DOCKERHUB_USERNAME }}/online-shop:latest"
          
          echo "âœ… Main infrastructure destroyed"

  # Job 2: Destroy Backend Infrastructure with Terraform
  destroy-backend:
    name: Destroy Backend with Terraform
    runs-on: ubuntu-latest
    needs: destroy-infrastructure
    if: github.event.inputs.confirm == 'destroy'
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.6.0"

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Destroy Backend Infrastructure with Terraform
        run: |
          echo "ğŸ”¥ Destroying backend infrastructure with Terraform..."
          cd infrastructure/backend
          
          # Initialize Terraform (uses local state for backend resources)
          terraform init
          
          # Plan destruction (for visibility)
          echo "ğŸ“‹ Planning backend destruction..."
          terraform plan -destroy \
            -var="state_bucket_name=${{ secrets.STATE_BUCKET_NAME }}" \
            -var="dynamodb_table_name=${{ secrets.DYNAMODB_TABLE_NAME }}" \
            -var="aws_region=${{ env.AWS_REGION }}"
          
          # Destroy backend using Terraform state management
          echo "ğŸ”¥ Executing backend destruction..."
          terraform destroy -auto-approve \
            -var="state_bucket_name=${{ secrets.STATE_BUCKET_NAME }}" \
            -var="dynamodb_table_name=${{ secrets.DYNAMODB_TABLE_NAME }}" \
            -var="aws_region=${{ env.AWS_REGION }}"
          
          echo "âœ… Backend infrastructure destroyed with Terraform"

  # Job 3: Verify Complete Cleanup
  verify-cleanup:
    name: Verify Complete Cleanup
    runs-on: ubuntu-latest
    needs: [destroy-infrastructure, destroy-backend]
    if: github.event.inputs.confirm == 'destroy'
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Verify All Resources Destroyed
        run: |
          echo "ğŸ” Verifying complete cleanup..."
          CLEANUP_STATUS="COMPLETE"
          
          # Check S3 bucket
          echo "Checking S3 bucket: ${{ secrets.STATE_BUCKET_NAME }}"
          if aws s3api head-bucket --bucket "${{ secrets.STATE_BUCKET_NAME }}" --region "${{ env.AWS_REGION }}" 2>/dev/null; then
            echo "âŒ S3 bucket still exists"
            CLEANUP_STATUS="PARTIAL"
          else
            echo "âœ… S3 bucket successfully destroyed"
          fi
          
          # Check DynamoDB table
          echo "Checking DynamoDB table: ${{ secrets.DYNAMODB_TABLE_NAME }}"
          if aws dynamodb describe-table --table-name "${{ secrets.DYNAMODB_TABLE_NAME }}" --region "${{ env.AWS_REGION }}" 2>/dev/null; then
            TABLE_STATUS=$(aws dynamodb describe-table --table-name "${{ secrets.DYNAMODB_TABLE_NAME }}" --region "${{ env.AWS_REGION }}" --query 'Table.TableStatus' --output text 2>/dev/null || echo "NOT_FOUND")
            if [ "$TABLE_STATUS" = "DELETING" ]; then
              echo "â³ DynamoDB table is being deleted..."
              echo "âœ… DynamoDB table deletion in progress"
            else
              echo "âŒ DynamoDB table still exists"
              CLEANUP_STATUS="PARTIAL"
            fi
          else
            echo "âœ… DynamoDB table successfully destroyed"
          fi
          
          # Check for remaining EC2 instances
          echo "Checking for remaining EC2 instances..."
          INSTANCES=$(aws ec2 describe-instances \
            --filters "Name=tag:Project,Values=online-shop" "Name=instance-state-name,Values=running,pending,stopping,stopped" \
            --query 'Reservations[*].Instances[*].InstanceId' \
            --output text --region "${{ env.AWS_REGION }}")
          
          if [ -n "$INSTANCES" ] && [ "$INSTANCES" != "None" ] && [ "$INSTANCES" != "" ]; then
            echo "âŒ Found remaining EC2 instances: $INSTANCES"
            CLEANUP_STATUS="PARTIAL"
          else
            echo "âœ… No remaining EC2 instances"
          fi
          
          # Final status
          echo ""
          echo "ğŸ¯ Final Cleanup Status: $CLEANUP_STATUS"
          
          if [ "$CLEANUP_STATUS" = "COMPLETE" ]; then
            echo "ğŸ‰ All resources destroyed successfully!"
            echo "ğŸ’° Your AWS bill should now be minimal"
            echo "âœ… Complete end-to-end Terraform lifecycle validated"
          else
            echo "âš ï¸  Some resources may still exist"
            echo "ğŸ” Check AWS console for any remaining resources"
          fi

  # Job 4: Manual Cleanup Instructions
  manual-cleanup-instructions:
    name: Manual Cleanup Instructions
    runs-on: ubuntu-latest
    needs: [destroy-infrastructure, destroy-backend, verify-cleanup]
    if: github.event.inputs.confirm == 'destroy'
    steps:
      - name: Display Final Manual Cleanup Instructions
        run: |
          echo "ğŸ‰ Terraform destruction completed successfully!"
          echo ""
          echo "ğŸ“‹ Final manual cleanup step:"
          echo "The S3 bucket and its contents (including Terraform state files)"
          echo "have been preserved throughout the workflow to ensure proper"
          echo "Terraform state management."
          echo ""
          echo "ğŸ”§ Now you can manually clean up the S3 bucket:"
          echo "aws s3 rm s3://${{ secrets.STATE_BUCKET_NAME }} --recursive"
          echo "aws s3api delete-bucket --bucket ${{ secrets.STATE_BUCKET_NAME }} --region ${{ env.AWS_REGION }}"
          echo ""
          echo "âœ… This ensures:"
          echo "â€¢ Proper Terraform state management throughout destruction"
          echo "â€¢ Clean end-to-end Infrastructure as Code lifecycle"
          echo "â€¢ No orphaned resources"
          echo ""
          echo "ğŸ’° After manual cleanup, your AWS bill will be minimal!"

  # Job 5: Send Notification
  notify:
    name: Send Notification
    runs-on: ubuntu-latest
    needs: [destroy-infrastructure, destroy-backend, verify-cleanup, manual-cleanup-instructions]
    if: always() && github.event.inputs.confirm == 'destroy'
    steps:
      - name: Determine Status
        id: status
        run: |
          if [[ "${{ needs.destroy-infrastructure.result }}" == "success" ]] && \
             [[ "${{ needs.destroy-backend.result }}" == "success" ]] && \
             [[ "${{ needs.verify-cleanup.result }}" == "success" ]]; then
            echo "result=Success âœ…" >> $GITHUB_OUTPUT
            echo "message=All infrastructure destroyed successfully using Terraform" >> $GITHUB_OUTPUT
          else
            echo "result=Partial âš ï¸" >> $GITHUB_OUTPUT
            echo "message=Some destruction steps may need manual completion" >> $GITHUB_OUTPUT
          fi

      - name: Send Email Notification
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "ğŸ”¥ Infrastructure Destruction - ${{ steps.status.outputs.result }}"
          to: ${{ secrets.MAIL_TO }}
          from: ${{ secrets.MAIL_FROM }}
          html_body: |
            <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
              <h2 style="color: #d73a49;">ğŸ”¥ Infrastructure Destruction Complete</h2>
              <p><strong>Status:</strong> ${{ steps.status.outputs.result }}</p>
              <p><strong>Message:</strong> ${{ steps.status.outputs.message }}</p>
              <hr>
              <h3>Destruction Details:</h3>
              <ul>
                <li><strong>Repository:</strong> ${{ github.repository }}</li>
                <li><strong>Triggered by:</strong> ${{ github.actor }}</li>
                <li><strong>Method:</strong> Terraform State Management</li>
                <li><strong>Manual Step:</strong> S3 bucket cleanup (after workflow success)</li>
              </ul>
              <hr>
              <h3>Job Results:</h3>
              <ul>
                <li>Destroy Infrastructure: ${{ needs.destroy-infrastructure.result }}</li>
                <li>Destroy Backend: ${{ needs.destroy-backend.result }}</li>
                <li>Verify Cleanup: ${{ needs.verify-cleanup.result }}</li>
              </ul>
              <hr>
              <h3>ğŸ’¡ Process Used:</h3>
              <p>This destruction used proper Terraform state management:</p>
              <ol>
                <li>âœ… Main infrastructure destroyed via Terraform</li>
                <li>âœ… Backend destroyed via Terraform (state preserved)</li>
                <li>âœ… Complete cleanup verification</li>
                <li>âš ï¸ Manual S3 cleanup after workflow success</li>
              </ol>
              <p><strong>Final Step:</strong> Manually delete S3 bucket after receiving this email</p>
              <p><a href="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}">View Full Details</a></p>
            </div>
        continue-on-error: true
